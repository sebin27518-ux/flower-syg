<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Romantic Flower Letter</title>
  <style>
    body { margin: 0; overflow: hidden; background: #050505; font-family: 'Apple SD Gothic Neo', sans-serif; }
    canvas { display: block; }

    #ui-layer {
      position: absolute; top: 70%; left: 50%;
      transform: translate(-50%, -50%); z-index: 100;
      pointer-events: none;
    }

    .envelope-wrapper {
      position: relative; width: 400px; height: 300px;
      perspective: 1500px; margin-left: 150px;
    }

    .envelope {
      width: 400px; height: 300px; background: #f5f5f5;
      position: absolute; bottom: 0; left: 0;
      border-radius: 0 0 15px 15px; display: none; cursor: pointer;
      box-shadow: 0 25px 60px rgba(0,0,0,0.8); z-index: 10;
      pointer-events: auto;
    }

    .letter {
      width: 400px; height: 350px; background: #fffde7;
      position: absolute; bottom: 0; left: 0;
      transform: translateY(0); transition: transform 2s ease-in-out, opacity 1s;
      z-index: 5; padding: 30px; box-sizing: border-box;
      font-size: 16px; color: #333; line-height: 1.7; border: 1px solid #fbc02d;
      visibility: hidden; opacity: 0; pointer-events: auto;
      text-align: center; display: flex; flex-direction: column; justify-content: center;
    }

    .envelope-front {
      position: absolute; bottom: 0; left: 0;
      width: 100%; height: 100%; background: #ffffff;
      clip-path: polygon(0 0, 50% 55%, 100% 0, 100% 100%, 0 100%);
      border-radius: 0 0 15px 15px; z-index: 30;
    }

    .flap {
      position: absolute; top: 0; left: 0; width: 0; height: 0;
      border-left: 200px solid transparent; border-right: 200px solid transparent;
      border-top: 160px solid #e5e5e5;
      transform-origin: top; transition: transform 1.2s ease;
      z-index: 40;
    }

    /* 편지 부상 및 하강 연출 */
    .envelope.open .letter { transform: translateY(-350px); visibility: visible; opacity: 1; z-index: 50; }
    .envelope.open .flap { transform: rotateX(180deg); border-top-color: #ffffff; }

    .envelope.closing .letter { transform: translateY(0); opacity: 0; }
    .envelope.closing .flap { transform: rotateX(0deg); transition-delay: 1.5s; }

    #btn-bundle {
      position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
      padding: 18px 45px; font-size: 20px; border-radius: 50px;
      border: none; background: #ffeb3b; color: #333; font-weight: bold;
      cursor: pointer; display: none; z-index: 1000; pointer-events: auto;
    }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="ui-layer">
  <div class="envelope-wrapper">
    <div class="envelope" id="envelope" onclick="openLetter()">
      <div class="flap"></div>
      <div class="envelope-front"></div>
      <div class="letter" id="letter" onclick="closeLetter(event)">
        <p style="margin:0 0 10px 0;">
          꽃을 직접 주고 싶은데 들고가기 힘들 거 같아서...<br>
          프리지아와 안개꽃임니다. 변치 마음으로 사랑할게<br>
          늘 나랑 함께 해줘서 정말 고마워<br>
          힘들 텐데 내가 너를 자주 볼 수 있게<br>
          대전으로 와줘서 너무 고맙고...<br>
          아직 입출력 값이 확실하지 않는데<br>
          딥러닝 하는 중이니까... 조금만 기다려 줘<br>
          평생 보자는 말은 듣기는 좋지만<br>
          너무 현실성 없으니까, 우리 정말 오래오래 보자<br>
          일단 우리 내일도 만나자!!<br>
          (이런 말 할 수 있어서 굉장히 신남)<br>
          사랑해 영아 정말 사랑해!!!!
        </p>
      </div>
    </div>
  </div>
</div>
<button id="btn-bundle">꽃다발 만들기</button>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const btnBundle = document.getElementById('btn-bundle');
  const envelope = document.getElementById('envelope');

  let w, h;
  function res() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
  window.onresize = res; res();

  let flowers = [];
  let isBundling = false;
  let isClosing = false;
  let moveStep = 0; // 꽃다발 이동 단계 제어용

  function openLetter() { if (!isClosing) envelope.classList.add('open'); }

  function closeLetter(e) {
    e.stopPropagation();
    isClosing = true;
    envelope.classList.remove('open');
    envelope.classList.add('closing');

    // 꽃들이 편지지와 함께 쏙 들어가도록 타이밍 조절
    flowers.forEach(f => { f.locked = false; f.closing = true; });
  }

  function drawFreesia(ctx, x, y, scale) {
    ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
    for (let j = 0; j < 5; j++) {
      ctx.rotate((Math.PI * 2) / 5);
      let grad = ctx.createRadialGradient(0, 0, 2, 0, 0, 20);
      grad.addColorStop(0, '#FBC02D'); grad.addColorStop(1, '#FFEB3B');
      ctx.beginPath(); ctx.fillStyle = grad; ctx.moveTo(0, 0);
      ctx.bezierCurveTo(15, -15, 12, -35, 0, -40); ctx.bezierCurveTo(-12, -35, -15, -15, 0, 0);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawGypsophila(ctx, x, y, seed, scale) {
    ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
    let rand = (s) => { let t = s * 12345.678; return t - Math.floor(t); };
    ctx.fillStyle = "white";
    for (let i = 0; i < 8; i++) {
      const a = (Math.PI * 2 / 8) * i;
      const dist = 10 + rand(seed + i) * 12;
      ctx.beginPath(); ctx.arc(Math.cos(a) * dist, Math.sin(a) * dist, 2.5, 0, Math.PI * 2); ctx.fill();
    }
    ctx.restore();
  }

  class Flower {
    constructor(x, y, type) {
      this.x = x; this.y = y;
      this.currX = x; this.currY = h;
      this.type = type; this.seed = Math.random();
      this.isB = false; this.locked = false; this.closing = false;
      this.scale = 1.0;
      // 1단계: 왼쪽 꽃다발 위치
      this.bOffX = -350 + (Math.random() * 180);
      this.bOffY = -120 - (Math.random() * 80);
    }
    update() {
      if (this.locked && !this.closing) return;
      let uiY = h * 0.7;

      if (!this.closing) {
        if (this.currY > this.y) { this.currY -= 15; } else { this.isB = true; }
        if (isBundling && this.isB) {
          this.scale = 1.6;
          let tx = w / 2 + this.bOffX;
          let ty = uiY + this.bOffY;
          let dx = tx - this.currX; let dy = ty - this.currY;
          if (Math.abs(dx) < 1 && Math.abs(dy) < 1) { this.currX = tx; this.currY = ty; this.locked = true; }
          else { this.currX += dx * 0.1; this.currY += dy * 0.1; }
        }
      } else {
        // 편지지와 겹치기: 꽃들이 편지지 위치(오른쪽)로 슬쩍 이동 후 함께 하강
        let targetX = w / 2 + 150 + (this.bOffX + 250); // 편지지 중심 근처
        let targetY = uiY + 100; // 봉투 안쪽 깊은 곳

        this.currX += (targetX - this.currX) * 0.04;
        this.currY += (targetY - this.currY) * 0.04; // 편지와 속도 맞춰 내려감
        this.scale *= 0.99; // 크기는 유지하다가 서서히 줄어듦
        if (this.scale < 0.1) this.locked = true;
      }
    }
    draw() {
      if (this.scale < 0.05) return;
      ctx.beginPath();
      ctx.strokeStyle = `rgba(46, 125, 50, ${this.scale})`;
      ctx.lineWidth = 3 * this.scale;

      let startX = isBundling ? (this.closing ? this.currX : w / 2 - 250) : this.currX;
      let startY = isBundling ? (this.closing ? this.currY + 180 : h * 0.7 + 180) : h;

      ctx.moveTo(startX, startY); ctx.lineTo(this.currX, this.currY); ctx.stroke();
      if (this.isB) {
        if (this.type === 'freesia') drawFreesia(ctx, this.currX, this.currY, this.scale);
        else drawGypsophila(ctx, this.currX, this.currY, this.seed, this.scale);
      }
    }
  }

  canvas.addEventListener('mousedown', (e) => {
    if (isBundling) return;
    flowers.push(new Flower(e.clientX, e.clientY, Math.random() > 0.5 ? 'freesia' : 'gypsophila'));
    if (flowers.length >= 10) btnBundle.style.display = 'block';
  });

  btnBundle.onclick = (e) => {
    e.stopPropagation(); isBundling = true; btnBundle.style.display = 'none';
    setTimeout(() => { envelope.style.display = 'block'; }, 1200);
  };

  function animate() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, w, h);
    flowers.forEach(f => { f.update(); f.draw(); });
    requestAnimationFrame(animate);
  }
  animate();
</script>
</body>
</html>